# System Design социальной сети для курса по System Design

## Требования

### Функциональные требования

#### Публикация постов

- Загрузка фотографий.
- Добавление текстового описания.
- Привязка к геолокации.

#### Реакции и комментарии

- Лайки/дизлайки.
- Комментирование.
- Сортировка комментариев по времени.

#### Подписки

- Подписка/отписка от пользователей.

#### Поиск

- Поиск популярных мест для путешествий

#### Ленты

- Просмотр ленты других путешественников и ленты пользователя.
- Персональная лента подписок (обратный хронологический порядок).
- Просмотр ленты по поиску популярных мест

### Нефункциональные требования

- Поддержка 10 млн DAU с линейным ростом;
- Доступность 99.9%
- Аудитория стран СНГ;
- Мобильное устройство и браузер;
- Данные храним всегда;
- Сезонность: Да, сезон отпусков и крупные праздники (Peak);
- Тайминги
  - Публикация поста 
    - **Regular (p95)**: *400–800 мс*;
    - **Peak (p99)**: *1200–2500 мс*;
  - Пресайнд URL + загрузка CDN (S3)
    - **Regular (p95)**: *100–150 мс*
    - **Peak (p99)**: *200–400 мс*	
  - Просмотр ленты	
    - **Regular (p95)**: *1200–1500 мс*	
    - **Peak (p99)**: *1500–1700 мс*
  - Реакции	
    - **Regular (p95)**: *150–200 мс*	
    - **Peak (p99)**: *200–400 мс*
  - Оставить комментарий	
    - **Regular (p95)**: *300–500 мс*	
    - **Peak (p99)**: *500–800 мс*
  - Показать комментарии	
    - **Regular (p95)**: *500–1000 мс*	
    - **Peak (p99)**: *1000–1200 мс*
  - Подписи	
    - **Regular (p95)**: *200–400 мс*	
    - **Peak (p99)**: *500–1000 мс*
  - Поиск по геолокации	
    - **Regular (p95)**: *1500–1800 мс*	
    - **Peak (p99)**: *2000–3000 мс*	
  - CDN (загрузка фото)	
    - **Regular (p95)**: *200–300 мс*	
    - **Peak (p99)**: *300–500 мс*
- Лимиты
  - Макс. количество фотографий на пост: *5*
  - Макс. размер загружаемых фотографий: *2 MB*
  - Макс. количество символов в описании поста: *500*
  - Макс. количество символов в комментарии: *500*
  - Макс. публикаций постов в день: *10*
  - Пагинация постов: *5*
  - Макс. подписчиков у пользователя: *100 000*
  - Макс. подписок у пользователя: *5 000*
  - Лимит новых подписок/день: *50*
  - Лайков в день: *500*
  - Комментариев в день: *100*
  - Пагинация комментариев: *10*
  - Мин. интервал между действиями (лайк/подписка/комментарий):	*1 сек*

## Оценка нагрузки

| Подсистема           | RPS            | Суточный объем  | Трафик (Мбит/с)     |
|----------------------|----------------|-----------------|---------------------|
|                      | Regular / Peak | Regular / Peak  | Regular / Peak      |
| Посты                |                |                 |                     |
| Публикация постов    | 12 / 29        | 1.37 / 3.5 ГБ   | ≈ 0.13 / 0.32       |
| Пресайнд URL (S3)    | 12 / 29        | 1 / 2.5 ГБ      | ≈ 0.1 / 0.22        |
| Просмотр постов      | 1 621 / 4 051  | 1.12 / 2.81 TБ  | ≈ 104 / 248         |
|                      |                |                 |                     |
| Комментарии          |                |                 |                     |
| Оставить комментарий | 17 / 69        | 1.55 / 6.15 ГБ  | ≈ 0.136 / 0.54      |
| Показать комментарии | 2 893 / 3 356  | 2.8 / 3.3 ТБ    | ≈ 263.84 / 306.06   |
|                      |                |                 |                     |
| Реакции              | 1 157 / 3 472  | 3.3 / 9.94 ГБ   | ≈ 0.3 / 0.89        |
| Подписки             | 58 / 64        | 160 / 176.95 МБ | ≈ 0.014 / 0.015     |
|                      |                |                 |                     |
| CDN                  | 1 633 / 4 080  | 1 / 2.6 ПБ      | ≈ 97 832 / 244 452  |

### Публикация постов

- *10% пользователей публикуют по 1 посту в день*

```
author_id - 16 байт
photos - 300 байт
description - 1000 байт
geo - 58 байт
```

- RPS = 1 000 000 / 86 400 = 12
- Traffic = 12 * (16 + 300 + 1000 + 58) = 16.5 кБ/с = 0.13 Мбит/с

**Peak x2.5**

- RPS = 2 500 000 / 86 400 = 29
- Traffic = 29 * (16 + 300 + 1000 + 58) = 40 кБ/с = 0.32 Мбит/с

#### Пресайнд URL (S3)

```
key - 100 байт
url - 100 байт
```

- Traffic = 12 * 5 * 200 = 12 кБ/c = 0.1 Мбит/с

**Peak x2.5**

- Traffic = 29 * 5 * 200 = 29 кБ/c = 0.22 Мбит/с

### Просмотр постов

- *Каждый пользователь просматривает 50 постов в день ленты*
- *Каждый пользователь просматривает 20 постов в день поиска*

```
post_id - 16 байт
author_id - 16 байт
username - 100 байт
avatar 100 байт
photos - 300 байт
description - 1000 байт
geo - 58 байт
likes - 4 байт
comments - 4 байт
is_liked - 1 байт
is_subscribed - 1 байт
created_at - 8 байт
```

- RPS = 140 000 000 / 86 400 = 1 621
- Traffic = 1 621 * 5 * 1 608 = 13 032 кБ/с = 104 Мбит/с

**Peak x2.5**

- RPS = 350 000 000 / 86 400 = 4 051
- Traffic = 4 051 * 5 * 1 608 = 32 570 кБ/с = 248 Мбит/с

#### Оценка ресурсов Постов

- Capacity = 40 * 86 400 * 365 = 1.3 ТБ
- DISKS: 
    - 4 109 / 100 = 42 (HDD)
    - 4 109 / 1 000 = 5 (SSD SATA)

- 40 + 29 + 32 570 = 32.639 МБ/с => 100 МБ/с = 1 disk (HDD)
- 1.3 ТБ / 2 ТБ = 1 disk 

Выбор в сторону **5 SSD SATA** дисков

### Реакции

- *Каждый пользователь ставит 10 реакций в день*

```
user_id - 16 байт
post_id - 16 байт
is_like - 1 байт
```

- RPS = 100 000 000 / 86 400 = 1 157
- Traffic = 1 157 * 33 = 38 кБ/с = 0.3 Мбит/с

**Peak x3**

- RPS = 300 000 000 / 86 400 = 3 472
- Traffic = 3 472 * 33 = 115 кБ/с = 0.89 Мбит/с

#### Оценка ресурсов Реакций

- Capacity = 115 * 86 400 * 365 = 3.6 ТБ
- DISKS:
    - 3 472 / 100 = 35 (HDD)
    - 3 472 / 1 000 = 4 (SSD SATA)

- 115 + 38 = 153 кБ/с => 100 МБ/с = 1 disk (HDD)
- 3.6 ТБ / 2 ТБ = 2 disk 

Выбор в сторону **4 SSD SATA** дисков

### Оставить комментарий

- *5% пользователей пишут по 3 комментария в день*

```
user_id - 16 байт
post_id - 16 байт
text - 1000 байт
```

- RPS = 1 500 000 / 86 400 = 17 
- Traffic = 17 * 1 032 = 17 кБ/с = 0.136 Мбит/с

**Peak x4**

- RPS = 6 000 000 / 86 400 = 69
- Traffic = 69 * 1 032 = 71.2 кБ/с = 0.54 Мбит/с

### Показать комментарии

- *Пользователи открывают комментарии только к 30% просмотренных постов (21 из 70).*
- *Из них 20% запрашивают вторую пачку комментариев.*

```
user_id - 16 байт
username - 100 байт
post_id - 16 байт
text - 1000 байт
create_at - 8 байт
```

21 (первые пачки) + 4 (пагинация) = 25 запросов.

- RPS = 250 000 000 / 86 400 = 2 893
- Traffic = 2 893 * 10 * 1 140 = 32 980 кБ/с = 263.84 Мбит/с

**Peak 15%**

- RPS = 290 000 000 / 86 400 = 3 356
- Traffic = 3 356 * 10 * 1 140 = 38 258 кБ/с = 306.06 Мбит/с

#### Оценка ресурсов Комментарий

- Capacity = 71.2 * 86 400 * 365 = 2.3 ТБ
- DISKS:
    - 3 425 / 100 = 35 (HDD)
    - 3 425 / 1 000 = 4 (SSD SATA)

- 71.2 + 38 258 = 38 MБ/с => 100 МБ/с = 1 disk (HDD)
- 2.3 ТБ / 2 ТБ = 2 disk 

Выбор в сторону **4 SSD SATA** дисков

### Подписки

- *5% пользователей совершают 10 действий с подписками в день*

```
author_id - 16 байт
subscriber_id - 16 байт
```

- RPS = 5 000 000 / 86 400 = 58
- Traffic = 58 * 32 = 1 856 байт/с = 0.014 Мбит/с

**Peak 10%**

- RPS = 5 500 000 / 86 400 = 64
- Traffic = 64 * 32 = 2 048 байт/с = 0.015 Мбит/с

#### Оценка ресурсов Подписки

- Capacity = 2 048 * 86 400 * 365 = 64.6 ГБ
- DISKS:
    - 64 / 100 = 1 (HDD)

- 2 048 байт/с => 100 МБ/с = 1 disk (HDD)
- 64.6 ГБ / 500 ГБ = 1 disk 

Выбор в сторону **2 HDD** диска

### CDN

- Публикация постов - **12 RPS** - 3 фото в среднем по 2 Мбайта
- Просмотр постов (пагинация по 5)
  - Посты - **1 621 RPS** - 3 фото в среднем по 0.5 Мбайт (cжатие)


- RPS = 12 + 1 621 = 1 633
- Traffic = (12 * 3 * 2) + (1 621 * 5 * 3 * 0.5) = 12 229 Мбайт/с = 97 832 Мбит/с

**Peak**

- RPS = 29 + 4 051 = 4 080
- Traffic = (29 * 3 * 2) + (4 051 * 5 * 3 * 0.5) = 30 556,5 Мбайт/с = 244 452 Мбит/с

#### Оценка ресурсов S3

- Capacity = 29 * 3 * 2 * 86 400 * 365 = 5.5 ПБ
- DISKS:
    - 4 080 / 100 = 41 (HDD)
    - 4 080 / 1 000 = 4 (SSD SATA)

- 30 556,5 Мбайт/с => 100 МБ/с = 306 disk (HDD)
- 5.5 ПБ / 30 ТБ = 184 disk 

Выбор в сторону **306 HDD** дисков

### Connections

10 000 000 * 0.1 = 1 000 000
